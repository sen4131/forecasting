# Cleveland et al. (1990) Sesonal-Trend Decomposition Procedure based on Loess
# https://www.wessa.net/download/stl.pdf

'''
EXTRACT FROM DATABASE

select call_date, sum(gross_calls), sum(offered_calls)
from mdb2prodrdm.dniswo_call_summary_new_ibs
group by CALL_DATE
order by CALL_DATE;
'''

#install packages
install.packages("forecast")
install.packages("ggplot2")
install.packages("tidyverse")
install.packages("Hmisc")
install.packages("psych")
install.packages("data.table")
install.packages("caTools")

#load libraries
library("forecast") #models and graph
library("ggplot2") #graph
library("tidyverse")
library("Hmisc") #summary
library("psych") #summary
library("data.table") #data manipulation
library("caTools") #train-test split

#
#1. DATA PREPROCESSING
#
df <- read.csv("C:/Users/P2877594/grossNoffered.csv")
df <- data.frame(df)
names(df) <- c("Date","Gross","Offered")

#1.1 Summary of data
dim(df)
view(df)
describe(df)

#1.2 HIGH OVERVIEW OF DATA CHARACTERISTICS
ts.plot(df[,3], main = "Time series plot of Offered Calls", ylab = "Calls")
hist(df[,3], main = "Hist of offered calls dist", xlab="Offered", freq = TRUE, col = 'dark green') 
#curve (dnorm(x,mean=mean(df[,2]), sd = sd(df[,2])),add=TRUE)
boxplot(df[,3], col = 'lightblue')


#1.3 Clean data and split train and test
#1.3.1 Clean
df_clean <-  subset(df,df[3]>1000)
df_clean <-  subset(df_clean,df_clean$Offered<80000)
df_clean$Date = as.Date(df_clean$Date, '%d-%b-%y')
#1.3.2 Train test split and transform to TS
offered_calls = ts(df_clean[,3], frequency = 7)
offered_train <- ts(offered_calls[1:(length(offered_calls)-26)], frequency = 7)
offered_test <- ts(offered_calls[(length(offered_calls)-25):length(offered_calls)], frequency = 7)


#
#2. Modeling Forecasts
#
#2.1 STL decomposition (Seasonal and Trend decomposition using Loess)
autoplot(decompose(offered_calls))
fit <- stlf(offered_train, method='naive')
fc <- (forecast(fit,h=25))
autoplot(offered_calls) +
  autolayer(fc, series="STL", PI=FALSE)+
  guides(colour=guide_legend(title="Daily forecasts"))

#2.2 Neural Nets
fit <- nnetar(offered_train, lambda=0)
fc <- (forecast(fit,h=25))
autoplot(offered_calls) +
  autolayer(fc, series="Neural Nets", PI=FALSE)+
  guides(colour=guide_legend(title="Daily forecasts"))

#2.3 Holt-Wintersâ€™ seasonal method
fc <- hw(offered_train,damped = TRUE, seasonal="multiplicative", h=25)
autoplot(offered_calls) +
  autolayer(fc, series="HW multi damped", PI=FALSE)+
  guides(colour=guide_legend(title="Daily forecasts"))

#
#3. Testing and Accuracy
#
cafe.test <- stl(test, model=fit)
accuracy(cafe.test)





